<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bivariate scatter graph maker</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 40px; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .controls { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-left: 5px; }
        .chart-area { width: 100%; height: 500px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Bivariate scatter graph maker</h1>
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" />
        <p id="status-msg"><small>Upload a CSV or use ?file=path/to.csv in the URL.</small></p>
        <ul>
            <li><a href="index.html?file=data/sports.csv" alt="sport science dataset">Sport Science Dataset</a></li>
            <li><a href="index.html?file=data/cars.csv" alt="cars dataset">Cars Dataset</a></li>
        </ul>
    </div>
    <div id="feed"></div>
</div>

<script>
    let globalData = [];
    let globalHeaders = [];

    // Check for URL parameters
    window.addEventListener('load', () => {
        console.log("App initialized");
        const urlParams = new URLSearchParams(window.location.search);
        const fileParam = urlParams.get('file');

        if (fileParam) {
            console.log("Found URL parameter:", fileParam);
            loadCsvFromUrl(fileParam);
        }
    });

    // HANDLE MANUAL UPLOAD
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: processResults
        });
    });

    // FETCH FROM URL
    function loadCsvFromUrl(path) {
        document.getElementById('status-msg').innerText = "Loading data from URL...";
        Papa.parse(path, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: processResults,
            error: (err) => alert("Error loading CSV via URL: " + err)
        });
    }

    // COMMON PROCESSING LOGIC
    function processResults(results) {
        console.log("Data parsed:", results.data.length, "rows");
        // Filter for numeric headers only
        globalData = results.data.filter(row => Object.values(row).some(v => v !== null));
        globalHeaders = results.meta.fields.filter(h => typeof globalData[0][h] === 'number');
        
        if (globalHeaders.length < 2) {
            alert("Need at least 2 numeric columns for correlation charts!");
            return;
        }
        renderFeed();
    }

    function cleanId(str) {
        return "chart-" + str.replace(/[^a-z0-9]/gi, '');
    }

    function renderFeed() {
        const feed = document.getElementById('feed');
        feed.innerHTML = ''; 
        for (let i = 0; i < globalHeaders.length; i++) {
            for (let j = i + 1; j < globalHeaders.length; j++) {
                createChartCard(globalHeaders[i], globalHeaders[j]);
            }
        }
    }

    function createChartCard(xAttr, yAttr) {
        const safeId = cleanId(xAttr + yAttr);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="chart-header">
                <h3>${xAttr} <span style="color:#888">vs</span> ${yAttr}</h3>
                <div>
                    <button id="trend-${safeId}">➕ Add Trendline</button>
                    <button id="swap-${safeId}">⇄ Swap Axes</button>
                </div>
            </div>
            <div id="${safeId}" class="chart-area"></div>
        `;
        document.getElementById('feed').appendChild(card);
        
        // Initial Draw
        drawPlot(safeId, xAttr, yAttr);

        // Add Event Listeners (Cleaner than inline onclick)
        document.getElementById(`trend-${safeId}`).onclick = () => drawPlot(safeId, xAttr, yAttr, true);
        document.getElementById(`swap-${safeId}`).onclick = () => swapAxes(safeId, xAttr, yAttr);
    }

    function drawPlot(id, xAttr, yAttr, showTrend = false) {
        const xData = globalData.map(row => row[xAttr]);
        const yData = globalData.map(row => row[yAttr]);

        const traces = [{
            x: xData,
            y: yData,
            mode: 'markers',
            name: 'Data',
            marker: { size: 9, color: '#007bff', opacity: 0.5 }
        }];

        if (showTrend) {
            const reg = calcLinearRegression(xData, yData);
            traces.push({
                x: reg.x,
                y: reg.y,
                mode: 'lines',
                name: `Fit (R²: ${reg.r2})`,
                line: { color: 'red', width: 2 }
            });
        }

        Plotly.newPlot(id, traces, { 
            xaxis: { title: xAttr }, 
            yaxis: { title: yAttr },
            margin: { t: 10 } 
        });
    }

    function calcLinearRegression(x, y) {
        const n = x.length;
        let sX = 0, sY = 0, sXY = 0, sX2 = 0, sY2 = 0;
        for (let i = 0; i < n; i++) {
            sX += x[i]; sY += y[i]; sXY += x[i]*y[i]; sX2 += x[i]*x[i]; sY2 += y[i]*y[i];
        }
        const slope = (n * sXY - sX * sY) / (n * sX2 - sX * sX);
        const intercept = (sY - slope * sX) / n;
        
        // Real R² calculation
        const xM = sX/n, yM = sY/n;
        let num = 0, dX = 0, dY = 0;
        for (let i=0; i<n; i++) {
            num += (x[i]-xM)*(y[i]-yM);
            dX += Math.pow(x[i]-xM, 2);
            dY += Math.pow(y[i]-yM, 2);
        }
        const r2 = Math.pow(num, 2) / (dX * dY);

        return {
            x: [Math.min(...x), Math.max(...x)],
            y: [Math.min(...x)*slope+intercept, Math.max(...x)*slope+intercept],
            r2: r2.toFixed(3)
        };
    }

    function swapAxes(id, x, y) {
        // Find the card container to update its specific buttons/title
        const card = document.getElementById(id).closest('.card');
        card.querySelector('h3').innerHTML = `${y} <span style="color:#888">vs</span> ${x}`;
        
        drawPlot(id, y, x);

        // Re-bind buttons with swapped attributes
        card.querySelector(`[id^="trend-"]`).onclick = () => drawPlot(id, y, x, true);
        card.querySelector(`[id^="swap-"]`).onclick = () => swapAxes(id, y, x);
    }
</script>

</body>
</html>