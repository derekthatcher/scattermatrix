<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bivariate scatter graph maker</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 40px; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .controls { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-left: 5px; }
        .chart-area { width: 100%; height: 500px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Bivariate scatter graph maker</h1>
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" />
        <p id="status-msg"><small>Upload a CSV or use ?file=path/to.csv in the URL.</small></p>
        <ul>
            <li><a href="index.html?file=data/sports.csv" alt="sport science dataset">Sport Science Dataset</a></li>
            <li><a href="index.html?file=data/cars.csv" alt="cars dataset">Cars Dataset</a></li>
            <li><a href="index.html?file=data/crime.csv" alt="Communities and Crime dataset">Communities and Crime dataset</a></li>
        </ul>
    </div>
    <div id="feed"></div>
</div>

<script>
    let globalData = [];
    let globalHeaders = [];

    // Check for URL parameters
    window.addEventListener('load', () => {
        console.log("App initialized");
        const urlParams = new URLSearchParams(window.location.search);
        const fileParam = urlParams.get('file');

        if (fileParam) {
            console.log("Found URL parameter:", fileParam);
            loadCsvFromUrl(fileParam);
        }
    });

    // HANDLE MANUAL UPLOAD
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: processResults
        });
    });

    // FETCH FROM URL
    function loadCsvFromUrl(path) {
        document.getElementById('status-msg').innerText = "Loading data from URL...";
        Papa.parse(path, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: processResults,
            error: (err) => alert("Error loading CSV via URL: " + err)
        });
    }

    // COMMON PROCESSING LOGIC
    function processResults(results) {
        console.log("Data parsed:", results.data.length, "rows");
        // Filter for numeric headers only
        globalData = results.data.filter(row => Object.values(row).some(v => v !== null));
        globalHeaders = results.meta.fields.filter(h => typeof globalData[0][h] === 'number');
        
        if (globalHeaders.length < 2) {
            alert("Need at least 2 numeric columns for correlation charts!");
            return;
        }
        renderFeed();
    }

    function cleanId(str) {
        return "chart-" + str.replace(/[^a-z0-9]/gi, '');
    }

    function renderFeed() {
        const feed = document.getElementById('feed');
        feed.innerHTML = ''; 
        for (let i = 0; i < globalHeaders.length; i++) {
            for (let j = i + 1; j < globalHeaders.length; j++) {
                createChartCard(globalHeaders[i], globalHeaders[j]);
            }
        }
    }

    function createChartCard(xAttr, yAttr) {
    const safeId = cleanId(xAttr + yAttr);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <div class="chart-header">
            <h3>${xAttr} <span style="color:#888">vs</span> ${yAttr}</h3>
            <div>
                <select id="model-${safeId}" style="padding: 8px; border-radius: 5px;">
                    <option value="none">No Trendline</option>
                    <option value="linear">Linear Fit</option>
                    <option value="exponential">Exponential Fit</option>
                    <option value="logarithmic">Logarithmic Fit</option>
                </select>
                <button id="swap-${safeId}">⇄ Swap Axes</button>
            </div>
        </div>
        <div id="${safeId}" class="chart-area"></div>
    `;
    document.getElementById('feed').appendChild(card);
    
    drawPlot(safeId, xAttr, yAttr);

    // Event Listeners
    document.getElementById(`model-${safeId}`).onchange = (e) => {
        drawPlot(safeId, xAttr, yAttr, e.target.value);
    };
    document.getElementById(`swap-${safeId}`).onclick = () => swapAxes(safeId, xAttr, yAttr);
}

function drawPlot(id, xAttr, yAttr, modelType = "none") {
    const xData = globalData.map(row => row[xAttr]);
    const yData = globalData.map(row => row[yAttr]);

    const traces = [{
        x: xData, y: yData,
        mode: 'markers', name: 'Data',
        marker: { size: 9, color: '#007bff', opacity: 0.5 }
    }];

    if (modelType !== "none") {
        const reg = calculateRegression(xData, yData, modelType);
        if (reg) {
            traces.push({
                x: reg.x, y: reg.y,
                mode: 'lines',
                name: `${modelType.charAt(0).toUpperCase() + modelType.slice(1)} (R²: ${reg.r2})`,
                line: { color: '#ff4757', width: 3 }
            });
        }
    }

    Plotly.newPlot(id, traces, { 
        xaxis: { title: xAttr }, 
        yaxis: { title: yAttr },
        margin: { t: 10 },
        showlegend: true
    });
}

function calculateRegression(x, y, type) {
    const n = x.length;
    let regX = [], regY = [], r2 = 0;

    // Filter out non-positive values for Log/Exp to avoid NaN errors in stats
    const validData = x.map((val, i) => ({x: val, y: y[i]}))
                       .filter(d => (type === 'linear' || (d.x > 0 && d.y > 0)));
    
    const vx = validData.map(d => d.x);
    const vy = validData.map(d => d.y);

    if (type === 'linear') {
        return calcLinear(vx, vy);
    } else if (type === 'exponential') {
        // Exponential: y = ae^(bx) -> ln(y) = ln(a) + bx
        const logY = vy.map(val => Math.log(val));
        const lin = calcLinear(vx, logY);
        const a = Math.exp(lin.intercept);
        const b = lin.slope;
        
        const xSpan = Array.from({length: 50}, (_, i) => Math.min(...vx) + (i * (Math.max(...vx) - Math.min(...vx)) / 49));
        return {
            x: xSpan,
            y: xSpan.map(val => a * Math.exp(b * val)),
            r2: lin.r2 // Approximation via linearized data
        };
    } else if (type === 'logarithmic') {
        // Logarithmic: y = a + b*ln(x)
        const logX = vx.map(val => Math.log(val));
        const lin = calcLinear(logX, vy);
        
        const xSpan = Array.from({length: 50}, (_, i) => Math.min(...vx) + (i * (Math.max(...vx) - Math.min(...vx)) / 49));
        return {
            x: xSpan,
            y: xSpan.map(val => lin.intercept + lin.slope * Math.log(val)),
            r2: lin.r2
        };
    }
}

// Internal helper for the heavy lifting
function calcLinear(x, y) {
    const n = x.length;
    let sX=0, sY=0, sXY=0, sX2=0, sY2=0;
    for (let i=0; i<n; i++) {
        sX+=x[i]; sY+=y[i]; sXY+=x[i]*y[i]; sX2+=x[i]*x[i]; sY2+=y[i]*y[i];
    }
    const slope = (n*sXY - sX*sY) / (n*sX2 - sX*sX);
    const intercept = (sY - slope*sX) / n;
    
    // R2 calculation
    const xM = sX/n, yM = sY/n;
    let num=0, dX=0, dY=0;
    for (let i=0; i<n; i++) {
        num += (x[i]-xM)*(y[i]-yM);
        dX += (x[i]-xM)**2;
        dY += (y[i]-yM)**2;
    }
    return { 
        slope, intercept, 
        r2: (num**2 / (dX * dY)).toFixed(3),
        x: [Math.min(...x), Math.max(...x)],
        y: [Math.min(...x)*slope+intercept, Math.max(...x)*slope+intercept]
    };
}

    function swapAxes(id, x, y) {
        // Find the card container to update its specific buttons/title
        const card = document.getElementById(id).closest('.card');
        card.querySelector('h3').innerHTML = `${y} <span style="color:#888">vs</span> ${x}`;
        
        drawPlot(id, y, x);

        // Re-bind buttons with swapped attributes
        card.querySelector(`[id^="trend-"]`).onclick = () => drawPlot(id, y, x, true);
        card.querySelector(`[id^="swap-"]`).onclick = () => swapAxes(id, y, x);
    }
</script>

</body>
</html>