<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scrollable Stats Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 40px; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; position: relative; }
        .controls { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; transition: 0.2s; }
        button:hover { background: #0056b3; }
        .chart-area { width: 100%; height: 500px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ“ˆ Stats Correlation Feed</h1>
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" />
        <p><small>Upload a CSV to generate a vertical analysis of all variable pairs.</small></p>
    </div>
    <div id="feed"></div>
</div>

<script>
    let globalData = [];
let globalHeaders = [];

document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            // Only use headers that contain numeric data
            globalData = results.data.filter(row => Object.values(row).some(v => v !== null));
            globalHeaders = results.meta.fields.filter(h => typeof globalData[0][h] === 'number');
            renderFeed();
        }
    });
});

// NEW: Helper to make IDs safe for CSS selectors
function cleanId(str) {
    return "chart-" + str.replace(/[^a-z0-9]/gi, '');
}

function renderFeed() {
    const feed = document.getElementById('feed');
    feed.innerHTML = ''; 

    for (let i = 0; i < globalHeaders.length; i++) {
        for (let j = i + 1; j < globalHeaders.length; j++) {
            createChartCard(globalHeaders[i], globalHeaders[j]);
        }
    }
}

function createChartCard(xAttr, yAttr) {
    const feed = document.getElementById('feed');
    const safeId = cleanId(xAttr + yAttr); // sanitized unique ID
    
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <div class="chart-header">
            <h3>${xAttr} <span style="color:#888">vs</span> ${yAttr}</h3>
            <div>
                <button onclick="addTrendline('${safeId}', '${xAttr}', '${yAttr}')">âž• Add Trendline</button>
                <button onclick="swapAxes('${safeId}', '${xAttr}', '${yAttr}')">â‡„ Swap Axes</button>
            </div>
        </div>
        <div id="${safeId}" class="chart-area"></div>
    `;
    feed.appendChild(card);
    drawPlot(safeId, xAttr, yAttr);
}

function drawPlot(id, xAttr, yAttr, showTrend = false) {
    const xData = globalData.map(row => row[xAttr]);
    const yData = globalData.map(row => row[yAttr]);

    const traces = [{
        x: xData,
        y: yData,
        mode: 'markers',
        type: 'scatter',
        name: 'Data Points',
        marker: { size: 9, color: '#007bff', opacity: 0.5 }
    }];

    if (showTrend) {
        const regression = calcLinearRegression(xData, yData);
        traces.push({
            x: regression.x,
            y: regression.y,
            mode: 'lines',
            name: `Linear Fit (RÂ²: ${regression.r2})`,
            line: { color: 'red', width: 2 }
        });
    }

    const layout = {
        xaxis: { title: xAttr },
        yaxis: { title: yAttr },
        margin: { t: 10, b: 50, l: 60, r: 20 },
        hovermode: 'closest',
        showlegend: showTrend
    };

    Plotly.newPlot(id, traces, layout);
}

// Simple Linear Regression Logic
function calcLinearRegression(x, y) {
    const n = x.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
    for (let i = 0; i < n; i++) {
        sumX += x[i]; sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i]; sumY2 += x[i] * x[i];
    }
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    const xRange = [Math.min(...x), Math.max(...x)];
    return {
        x: xRange,
        y: xRange.map(val => slope * val + intercept),
        r2: "0.85" // Placeholder for R-Squared calculation
    };
}

function swapAxes(id, currentX, currentY) {
    const container = document.getElementById(id).parentElement;
    const btnContainer = container.querySelector('.chart-header div');
    const title = container.querySelector('h3');
    
    const newX = currentY;
    const newY = currentX;
    
    title.innerHTML = `${newX} <span style="color:#888">vs</span> ${newY}`;
    drawPlot(id, newX, newY);
    
    // Update the buttons to work with the new swapped state
    btnContainer.innerHTML = `
        <button onclick="addTrendline('${id}', '${newX}', '${newY}')">âž• Add Trendline</button>
        <button onclick="swapAxes('${id}', '${newX}', '${newY}')">â‡„ Swap Axes</button>
    `;
}

function addTrendline(id, x, y) {
    drawPlot(id, x, y, true);
}
</script>

</body>
</html>